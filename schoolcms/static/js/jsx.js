const RB=ReactBootstrap;const RMR=ReactMiniRouter;var Alert=RB.Alert;var SC={}
SC.makeURL=function(path,query){var q=[];for(var key in query){q.push(encodeURIComponent(key)+'='+encodeURIComponent(query[key]));}
return path+'?'+(q.join('&'));}
SC.GroupPage=React.createClass({displayName:'GroupPage',render:function(){var group_tag=this.props.groups.map(function(group){return(React.createElement(RB.Label,{key:group.id,bsStyle:"primary"},group.name));});return(React.createElement(RB.Grid,null,React.createElement(RB.Row,null,React.createElement(RB.Col,null,React.createElement(RB.Well,null,React.createElement("h3",null,"群組"),React.createElement("hr",null),group_tag)))));}});SC.LoginForm=React.createClass({displayName:'LoginForm',mixins:[React.addons.LinkedStateMixin],getInitialState:function(){return{_xsrf:'',account:'',alert:null,};},componentWillMount:function(){var url='/api'+window.location.pathname+window.location.search;this.props.ajax(url,'GET',null,function(json){this.setState({_xsrf:json._xsrf,alert:json.alert});}.bind(this));},handleLogin:function(){var url='/api'+window.location.pathname;var form=new FormData(React.findDOMNode(this.refs.form));this.props.ajax(url,'POST',form,function(json){if(json.login){this.props.onLogin();RMR.navigate(this.props.next);}else{this.setState({alert:json.alert});}}.bind(this));},errorMsg:function(){if(this.state.alert){return(React.createElement(RB.Alert,{dismiss:true,bsStyle:"danger"},React.createElement("strong",null,"登入失敗!")," ",this.state.alert));}},render:function(){return(React.createElement("form",{ref:"form",onSubmit:function(e){e.preventDefault();e.stopPropagation();this.handleLogin();}.bind(this)},this.errorMsg(),React.createElement(RB.Input,{type:"hidden",name:"_xsrf",value:this.state._xsrf}),React.createElement(RB.Input,{type:"hidden",name:"next",value:this.props.next}),React.createElement(RB.Input,{type:"text",name:"account",valueLink:this.linkState('account'),placeholder:"帳號"}),React.createElement(RB.Input,{type:"password",name:"passwd",placeholder:"密碼"}),React.createElement(RB.Button,{bsStyle:"primary",className:"btn-flat",onClick:this.handleLogin},"登入")));},});SC.LoginPage=React.createClass({displayName:'LoginPage',componentWillMount:function(){var url='/api'+window.location.pathname+window.location.search;this.props.ajax(url,'GET',null,function(json){this.setState({_xsrf:json._xsrf,alert:json.alert});}.bind(this));},render:function(){return(React.createElement(RB.Grid,null,React.createElement(RB.Col,{xs:12,md:6,mdOffset:3},React.createElement(RB.Well,null,React.createElement("h1",null,"登入"),React.createElement("hr",null),React.createElement(SC.LoginForm,React.__spread({},this.props))))));}});SC.LogoutPage=React.createClass({displayName:'LogoutPage',componentWillMount:function(){var url='/api'+window.location.pathname;this.props.ajax(url,'GET',null,function(json){this.props.onLogout();RMR.navigate('/');}.bind(this));},render:function(){return(React.createElement("div",null));}});SC.AnnIndexPage=React.createClass({displayName:'AnnIndexPage',getInitialState:function(){return{annlist:[],};},componentWillMount:function(){var url='/api'+window.location.pathname+window.location.search;this.props.ajax(url,'GET',null,function(data){this.setState({annlist:data.anns,start:data.start,totle:data.totle});}.bind(this));},handleSearch:function(search){var url=SC.makeURL(window.location.pathname,{'start':this.props.start,'totle':this.props.totle,'search':search,});RMR.navigate(url,true);this.props.ajax('api'+url,'GET',null,function(data){this.setState({annlist:data.anns,start:data.start,totle:data.totle});}.bind(this));},render:function(){var annItems=this.state.annlist.map(function(ann){return(React.createElement("tr",{key:ann.id},React.createElement("td",null,React.createElement("a",{href:'/announce/'+ann.id},ann.title)),React.createElement("td",null,ann.created)));});return(React.createElement("div",null,React.createElement(RB.Grid,null,React.createElement(RB.Row,null,React.createElement(RB.Col,{xs:12,md:6},React.createElement("h1",null,"Announcement"),React.createElement("a",{href:"/announce/edit"},"New Announcement!"),React.createElement(SC.SearchAnnForm,{search:this.props.search,onSearch:this.handleSearch}))),React.createElement(RB.Row,null,React.createElement(RB.Col,{xs:12,md:12},React.createElement(RB.Well,null,React.createElement(RB.Table,{striped:true,bordered:true,hover:true},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"標題"),React.createElement("th",null,"公告時間"))),React.createElement("tbody",null,annItems))),React.createElement(SC.Pager,{start:this.props.start,totle:this.props.totle}))))));}});SC.SearchAnnForm=React.createClass({displayName:'SearchAnnForm',mixins:[React.addons.LinkedStateMixin],getInitialState:function(){return{search:this.props.search,};},handleSearch:function(){this.props.onSearch(this.state.search);},render:function(){var search_button=(React.createElement(RB.Button,{bsStyle:"primary",className:"btn-flat",onClick:this.handleSearch},"搜尋"));return(React.createElement("form",{onSubmit:function(e){e.preventDefault();e.stopPropagation();this.handleSearch();}.bind(this)},React.createElement(RB.Input,{rel:"search",type:"text",name:"search",valueLink:this.linkState('search'),placeholder:"搜尋公告",buttonAfter:search_button})));}})
SC.Pager=React.createClass({displayName:'Pager',pageUrl:function(start){return'/announce?start='+start;},render:function(){var max=function(a,b){return a>b?a:b;};var min=function(a,b){return a<b?a:b;};return(React.createElement(RB.Pager,null,React.createElement(RB.PageItem,{previous:true,href:this.pageUrl(max(0,this.props.start-10)),disabled:this.props.start<=0},"← Previous Page"),React.createElement(RB.PageItem,{next:true,href:this.pageUrl(this.props.start+10),disabled:this.props.start+10>=this.props.totle},"Next Page →")));}});SC.AnnouncePage=React.createClass({displayName:'AnnouncePage',render:function(){return(React.createElement(RB.Grid,null,React.createElement(RB.PageHeader,null,this.props.ann.title,React.createElement("small",null," by 設備組‧組長")),React.createElement(RB.Row,null,React.createElement(RB.Col,{xs:12,md:12},React.createElement(RB.Well,null,React.createElement("span",{dangerouslySetInnerHTML:{__html:marked(this.props.ann.content,{sanitize:true,breaks:true})}})))),React.createElement(RB.Row,null,React.createElement(RB.Col,{xs:12,md:6},React.createElement(RB.Well,null,React.createElement("h4",null,"附件"),React.createElement("hr",null),React.createElement(SC.AttachmentPanel,{attlist:this.props.attlist}))),React.createElement(RB.Col,{xs:12,md:6},React.createElement(RB.Well,null,React.createElement("h4",null,"時間"),React.createElement("hr",null),React.createElement("p",null,"發布於：",this.props.ann.created),React.createElement("p",null,"最後更新：",this.props.ann.updated)))),React.createElement(RB.Row,null,React.createElement(RB.Col,{xs:12,md:2},React.createElement("a",{className:"btn btn-warning btn-xs btn-block",href:'/announce/edit/'+this.props.ann.id},"編輯")),React.createElement(RB.Col,{xs:12,md:2},React.createElement("a",{className:"btn btn-primary btn-xs btn-block",href:"/announce/"},"返回")))));}});{}
SC.AttachmentPanel=React.createClass({displayName:'AttachmentPanel',_icon:['aac','ai','aiff','asp','avi','bmp','c','cpp','css','dat','dmg','doc','docx','dot','dotx','dwg','dxf','eps','exe','flv','gif','h','html','ics','iso','java','jpg','key','m4v','mid','mov','mp3','mp4','mpg','odp','ods','odt','otp','ots','ott','pdf','php','png','pps','ppt','pptx','psd','py','qt','rar','rb','rtf','sql','tga','tgz','tiff','txt','wav','xls','xlsx','xml','yml','zip'],_ms_office:['docx','doc','dot','dotx','xlsx','xlsb','xls','xlsm','pptx','ppsx','ppt','pps','pptm','potm','ppam','potx','ppsm'],openlink:function(att){if(this._ms_office.indexOf(att.filetype)>=0){return React.createElement("a",{target:"_blank",href:'https://view.officeapps.live.com/op/view.aspx?src='+encodeURIComponent(window.location.host+'/file/'+att.path)},"開啟")}else if(att.filetype!=='file'){return React.createElement("a",{target:"_blank",href:'/file/'+att.path},"開啟")}},render:function(){var attItems=this.props.attlist.map(function(att){if(this._icon.indexOf(att.filetype)<0){att.filetype='file';}
return(React.createElement("div",{key:att.key,className:"media"},React.createElement("div",{className:"media-left"},React.createElement("img",{src:'/static/icon/'+att.filetype+'.png',alt:att.filetype})),React.createElement("div",{className:"media-body"},React.createElement("div",{className:"media-heading"},att.filename),React.createElement("div",null,this.openlink(att),React.createElement("a",{href:'/file/'+att.path+'?download=1'},"下載")))));}.bind(this));if(this.props.attlist.length){return React.createElement("div",null,attItems);}else{return React.createElement("p",null,"沒有附件");}},});SC.EditAnnPage=React.createClass({displayName:'EditAnnPage',mixins:[React.addons.LinkedStateMixin],getInitialState:function(){return{title:'',content:'',tmpatts:[],atts:[],annid:'',_xsrf:'',};},componentWillMount:function(){var url='/api'+window.location.pathname;this.props.ajax(url,'GET',null,function(json){this.setState(json);}.bind(this));},render:function(){return(React.createElement(RB.Grid,null,React.createElement(RB.PageHeader,null,"編輯公告"),React.createElement("form",null,React.createElement(RB.Row,null,React.createElement(RB.Col,{xs:12,md:6},React.createElement(RB.Well,null,React.createElement(RB.Input,{type:"hidden",name:"_xsrf",value:this.state._xsrf}),React.createElement(RB.Input,{type:"text",name:"title",valueLink:this.linkState('title'),label:"公告標題",placeholder:"輸入公告標題"}),React.createElement(SC.ResizeTextArea,{name:"content",valueLink:this.linkState('content'),label:"公告內容",placeholder:"輸入公告內容"})),React.createElement(RB.Well,null,React.createElement("h4",null,"編輯附件"),React.createElement("hr",null),React.createElement(SC.EditAttPanel,{atts:this.state.atts,tmpatts:this.state.tmpatts,_xsrf:this.state._xsrf}))),React.createElement(RB.Col,{xs:12,md:6},React.createElement(RB.Well,null,React.createElement("h4",null,"預覽內容"),React.createElement("hr",null),React.createElement("span",{dangerouslySetInnerHTML:{__html:marked(this.state.content,{sanitize:true,breaks:true})}})))),React.createElement(RB.Row,null,React.createElement(RB.Col,{xs:12,md:2},React.createElement(RB.Button,{bsStyle:"success",bsSize:"xsmall",block:true,type:"submit"},"確定")),React.createElement(RB.Col,{xs:12,md:2},React.createElement("a",{className:"btn btn-primary btn-xs btn-block",href:'/announce/'+this.state.annid},"返回"))))));}});SC.EditAttPanel=React.createClass({displayName:'EditAttPanel',getInitialState:function(){return{tmpatts:this.props.tmpatts,atts:this.props.atts,};},handleChange:function(file){tmpatts=this.state.tmpatts;tmpatts.push(file);this.setState({tmpatts:tmpatts,});},handleDelete:function(att,upload){if(upload){tmpatts=this.state.tmpatts;tmpatts.splice(tmpatts.indexOf(att),1);this.setState({tmpatts:tmpatts,});}else{atts=this.state.atts;atts.splice(atts.indexOf(att),1);this.setState({atts:atts,});}},render:function(){var uploadedatts=this.state.atts.map(function(att){return React.createElement(SC.DeleteAttComponent,{key:att.key,att:att,handleDelete:this.handleDelete,_xsrf_token:this.props._xsrf_token})}.bind(this));var atts=this.state.tmpatts.map(function(att){return React.createElement(SC.DeleteAttComponent,{key:att.key,att:att,handleDelete:this.handleDelete,upload:true,_xsrf_token:this.props._xsrf_token})}.bind(this));return(React.createElement("div",null,uploadedatts,atts,React.createElement(SC.UploadAttBox,{_xsrf_token:this.props._xsrf_token,newUpload:this.handleChange})));}});SC.DeleteAttComponent=React.createClass({displayName:'DeleteAttComponent',uploadfile:function(){if(this.props.upload){return React.createElement(RB.Input,{key:0,type:"hidden",name:"attachment",value:this.props.att.key});}},deleteAtt:function(){if(!confirm('你確定要刪除 '+this.props.att.filename+' 嗎?'))return;xhr=new XMLHttpRequest();form=new FormData();form.append('_xsrf',this.props._xsrf_token);path=this.props.upload?'/fileupload/':'/file/';path+=this.props.att.key;xhr.open('DELETE',path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4&&xhr.status==200){console.log(xhr.responseText);this.props.handleDelete(this.props.att,this.props.upload);}}.bind(this);xhr.send(form);},render:function(){return(React.createElement(RB.Panel,{key:this.props.key},React.createElement(RB.Row,null,React.createElement(RB.Col,{xs:10,md:10},React.createElement("span",{className:"glyphicon glyphicon-file",'aria-hidden':"true"}),React.createElement("span",{className:"hideOverflow"},this.props.att.filename.substring(0,50))),React.createElement(RB.Col,{xs:2,md:2},React.createElement(RB.Button,{onClick:this.deleteAtt,bsStyle:"danger"},"刪除"),this.uploadfile()))));}});SC.UploadAttBox=React.createClass({displayName:'UploadAttBox',getInitialState:function(){return{file:'',filelist:{},};},handleChange:function(evt){file=evt.target.files[0];form=new FormData();xhr=new XMLHttpRequest();uuid=new Date().getTime();filelist=this.state.filelist;filelist[uuid]={percent:0.0,filename:file.name,};this.setState({filelist:filelist,file:'',});form.append('file',file);form.append('_xsrf',this.props._xsrf_token);xhr.open('POST','/fileupload',true);xhr.onreadystatechange=function(){if(xhr.readyState==4&&xhr.status==200){console.log(xhr.responseText);attfile=JSON.parse(xhr.responseText);this.props.newUpload({'filename':attfile.file_name,'key':attfile.key,});filelist=this.state.filelist;delete filelist[uuid];this.setState({filelist:filelist,})}}.bind(this);xhr.upload.onprogress=function(e){if(e.lengthComputable){filelist=this.state.filelist;filelist[uuid].percent=e.loaded*100/e.total;this.setState({filelist:filelist});}}.bind(this);xhr.send(form);},progressBar:function(uuid){return(React.createElement(RB.Panel,{key:uuid},React.createElement("span",{className:"glyphicon glyphicon-file",'aria-hidden':"true"}),this.state.filelist[uuid].filename,React.createElement(RB.ProgressBar,{active:true,now:this.state.filelist[uuid].percent,label:"%(percent)s%"})))},render:function(){var uploading=[];for(var i in this.state.filelist){uploading.push(this.progressBar(i));}
return(React.createElement("div",null,uploading,React.createElement(RB.Input,{type:"file",ref:"file",value:this.state.file,onChange:this.handleChange})));}});SC.App=React.createClass({displayName:'App',mixins:[RMR.RouterMixin],routes:{'/':'indexHandler','/login':'loginHandler','/logout':'logoutHandler','/admin/adduser':'adduserHandler','/announce':'annIndexHandler','/announce/edit':'editAnnHandler','/announce/edit/:annid':'editAnnHandler','/announce/:annid':'announceHandler','/group':'groupHandler','/grouplist':'groupListHandler',},ajax:function(url,method,data,callback){console.log('AJAX TO URL:'+url);var xhr=new XMLHttpRequest();xhr.open(method,url,true);this.setState({loading:0});xhr.onreadystatechange=function(){if(xhr.readyState==4){console.log('AJAX END');if(xhr.status){this.setState({status:xhr.status});}
setTimeout(function(){this.setState({loading:-1});}.bind(this),1000);if(xhr.status==200){callback(JSON.parse(xhr.response));}}}.bind(this);xhr.onprogress=function(e){if(e.lengthComputable){console.log('AJAX:'+e.loaded*100/e.total+'%');this.setState({loading:e.loaded*100/e.total});}}.bind(this);xhr.onerror=function(){this.setState({status:500});};xhr.send(data);},getInitialState:function(){return{loading:-1,status:200,current_user:null,};},componentDidMount:function(){this.getCurrentUser();$.material.init();},getCurrentUser:function(){this.ajax('/api','GET',null,function(json){this.setState({current_user:json.current_user});}.bind(this));},render:function(){var getPage=function(){if(this.state.status==200){return this.renderCurrentRoute();}else{return React.createElement("h1",null,"Geez, ",this.state.status);}}.bind(this);var progressBar=function(){if(this.state.loading>=0){return(React.createElement(RB.ProgressBar,{now:this.state.loading,bsStyle:"danger",style:{position:'fixed',top:'0px',height:'4px',width:'100%',zIndex:100,}}));}}.bind(this);return(React.createElement("div",null,progressBar(),React.createElement(SC.NavbarInstance,{current_user:this.state.current_user}),getPage()));},indexHandler:function(){return React.createElement("a",{href:"/announce"},"Announce");},loginHandler:function(params){if(!params.next){params.next='/';}
return React.createElement(SC.LoginPage,{ajax:this.ajax,next:params.next,onLogin:this.getCurrentUser});},logoutHandler:function(){return React.createElement(SC.LogoutPage,{ajax:this.ajax,onLogout:this.getCurrentUser});},adduserHandler:function(){return React.createElement(SC.LoginPage,null);},annIndexHandler:function(params){var toInt=function(i){return parseInt(i)?parseInt(i):0;}
params.start=toInt(params.start);params.totle=toInt(params.totle);return React.createElement(SC.AnnIndexPage,{ajax:this.ajax,start:params.start,totle:params.totle,search:params.search});},announceHandler:function(){return React.createElement(SC.LoginPage,null);},editAnnHandler:function(annid,params){return React.createElement(SC.EditAnnPage,{ajax:this.ajax});},groupHandler:function(){return React.createElement(SC.LoginPage,null);},groupListHandler:function(){return React.createElement(SC.LoginPage,null);},notFound:function(path){return React.createElement("div",{className:"not-found"},"Page Not Found: ",path);}});SC.NavbarInstance=React.createClass({displayName:'NavbarInstance',userSign:function(){if(this.props.current_user){return(React.createElement(RB.DropdownButton,{eventKey:1,title:this.props.current_user.name},React.createElement(RB.MenuItem,{eventKey:"1"},"Action"),React.createElement(RB.MenuItem,{eventKey:"2"},"Another action"),React.createElement(RB.MenuItem,{eventKey:"3"},"Something else here"),React.createElement(RB.MenuItem,{divider:true}),React.createElement(RB.MenuItem,{eventKey:"4",href:"/logout"},"Logout")))}else if(window.location.pathname.substr(0,6)!='/login'){return(React.createElement(RB.NavItem,{eventKey:1,href:'/login?next='+encodeURIComponent(window.location.pathname)},"Login"));}},render:function(){return(React.createElement(RB.Navbar,{brand:React.createElement("a",{href:"/"},"School Cms"),inverse:true,toggleNavKey:0},React.createElement(RB.Nav,{right:true,eventKey:0}," ",this.userSign())));},});SC.ResizeTextArea=React.createClass({displayName:'ResizeTextArea',getInitialState:function(){return{'value':this.props.value,}},textareaResize:function(){var textarea=React.findDOMNode(this.refs.textarea).getElementsByTagName('textarea')[0];textarea.style.height='0px'
textarea.style.height=textarea.scrollHeight+20+'px';if(this.props.onChange){this.props.onChange();}else if(this.props.valueLink){this.props.valueLink.requestChange(this.refs.textarea.getValue());}},getValue:function(){return this.refs.textarea.getValue();},render:function(){var out=['valueLink','onChange','type','ref'];var other={};for(var key in this.props){if(out.indexOf(key)===-1){other[key]=this.props[key];}}
other.className=(other.className?other.className:'')+'resizetextarea';return(React.createElement(RB.Input,React.__spread({},other,{type:"textarea",ref:"textarea",onChange:this.textareaResize,value:this.state.value})));}});